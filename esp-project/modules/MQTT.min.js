function g(a,b){this.server=a;b=b||{};this.port=b.port||n.DEF_PORT;this.client_id=b.client_id||t();this.keep_alive=b.keep_alive||n.DEF_KEEP_ALIVE;this.clean_session=b.clean_session||!0;this.username=b.username;this.password=b.password;this.connected=this.client=!1;this.ping_interval=this.keep_alive<this.C.PING_INTERVAL?this.keep_alive-5:this.C.PING_INTERVAL;this.protocol_name=b.protocol_name||"MQTT";this.protocol_level=f(parseInt((b.protocol_level||n.PROTOCOL_LEVEL).toString(16),
16))}function k(a){return f(a.length>>8,a.length&255)+a}function m(a,b,d){a=f(a);var c=b.length+d.length,h="";do{var q=c&127;c>>=7;0<c&&(q+=128);h+=f(q)}while(0<c);return a+h+b+d}function p(){l=65534<l?1:++l;return f(l>>8)+f(l&255)}function u(a,b,d,c){c|=e.PUBLISH<<4|d<<1;a=k(a);0<d&&(a+=p());return m(c,a,b)}function v(a,b){return m(e.SUBSCRIBE<<4|2,p(),k(a)+f(b))}function w(a){return m(e.UNSUBSCRIBE<<4|2,p(),k(a))}var n={PROTOCOL_LEVEL:4,DEF_PORT:1883,DEF_KEEP_ALIVE:60},e={CONNECT:1,CONNACK:2,PUBLISH:3,
PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14},l=Math.floor(65534*Math.random()),r={0:"ACCEPTED",1:"UNACCEPTABLE_PROTOCOL_VERSION",2:"IDENTIFIER_REJECTED",3:"SERVER_UNAVAILABLE",4:"BAD_USER_NAME_OR_PASSWORD",5:"NOT_AUTHORIZED"};g.prototype.C={DEF_QOS:0,CONNECT_TIMEOUT:1E4,PING_INTERVAL:40};var f=String.fromCharCode,t=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+
a()+a()}}();g.prototype.packetHandler=function(a){var b;this.partData&&(a=this.partData+a,this.partData="");var d=a.substr(1,5);var c=b=0;do{var h=d.charCodeAt(b);c|=(h&127)<<7*b++}while(h&128&&4>b);d=c;c=d+b+1;a.length<c?this.partData=a:(b=a.substr(b+1,d),a.length>c&&this.client.emit("data",a.substr(c)),d=a.charCodeAt(0),c=d>>4,c===e.PUBLISH?(a=(d&6)>>1,c=b.charCodeAt(0)<<8|b.charCodeAt(1),h=2+c+(a?2:0),a={topic:b.substr(2,c),message:b.substr(h,b.length-h),dup:(d&8)>>3,qos:a,pid:a?b.substr(2+c,2):
0,retain:d&1},a.qos&&this.client.write(f((1==a.qos?e.PUBACK:e.PUBREC)<<4)+"\u0002"+a.pid),this.emit("publish",a),this.emit("message",a.topic,a.message)):c===e.PUBACK?this.emit("puback",a.charCodeAt(2)<<8|a.charCodeAt(3)):c===e.PUBREC?this.client.write(f(e.PUBREL<<4|2)+"\u0002"+b.substr(0,2)):c===e.PUBREL?this.client.write(f(e.PUBCOMP<<4)+"\u0002"+b.substr(0,2)):c===e.PUBCOMP?this.emit("pubcomp",a.charCodeAt(2)<<8|a.charCodeAt(3)):c===e.SUBACK?0<b.length&&(128==b[b.length-1]?this.emit("subscribed_fail"):
this.emit("subscribed")):c===e.UNSUBACK?this.emit("unsubscribed"):c===e.PINGREQ?this.client.write(f(e.PINGRESP<<4)+"\x00"):c===e.PINGRESP?this.emit("ping_reply"):c===e.CONNACK?(this.ctimo&&clearTimeout(this.ctimo),this.ctimo=void 0,this.partData="",a=b.charCodeAt(3),"ACCEPTED"===r[a]?(this.connected=!0,this.pintr&&clearInterval(this.pintr),this.pintr=setInterval(this.ping.bind(this),1E3*this.ping_interval),this.emit("connected"),this.emit("connect")):(b="Connection refused, ",this.connected=!1,b=
0<a&&6>a?b+r[a]:b+("unknown return code: "+a+"."),this.emit("error",b))):this.emit("error","MQTT unsupported packet type: "+c))};g.prototype.connect=function(a){var b=this,d=function(){b.client=a;a.write(b.mqttConnect(b.client_id));b.ctimo=setTimeout(function(){b.ctimo=void 0;b.emit("disconnected");b.disconnect()},b.C.CONNECT_TIMEOUT);a.on("data",b.packetHandler.bind(b));a.on("end",function(){b._scktClosed()})};if(a)d();else try{a=require("net").connect({host:b.server,port:b.port},d)}catch(c){this.client=
!1,this.emit("error",c.message),this.emit("disconnected")}};g.prototype._scktClosed=function(){this.connected&&(this.client=this.connected=!1,this.pintr&&clearInterval(this.pintr),this.ctimo&&clearTimeout(this.ctimo),this.pintr=this.ctimo=void 0,this.emit("disconnected"),this.emit("close"))};g.prototype.disconnect=function(){if(this.client){try{this.client.write(f(e.DISCONNECT<<4)+"\x00")}catch(a){return this._scktClosed()}this.client.end();this.client=!1}};g.prototype.publish=function(a,b,d){if(this.client){d=
d||{};try{this.client.write(u(a,b.toString(),d.qos||this.C.DEF_QOS,(d.retain?1:0)|(d.dup?8:0)))}catch(c){this._scktClosed()}}};g.prototype.subscribe=function(a,b){if(this.client){b=b||{};var d=[];"string"===typeof a&&(a=[a]);Array.isArray(a)?a.forEach(function(c){d.push({topic:c,qos:b.qos||this.C.DEF_QOS})}.bind(this)):Object.keys(a).forEach(function(c){d.push({topic:c,qos:a[c]})});d.forEach(function(c){this.client.write(v(c.topic,c.qos))}.bind(this))}};g.prototype.unsubscribe=function(a){this.client&&
this.client.write(w(a))};g.prototype.ping=function(){if(this.client)try{this.client.write(f(e.PINGREQ<<4)+"\x00")}catch(a){this._scktClosed()}};g.prototype.createFlagsForConnection=function(a){var b=0|(this.username?128:0);b|=this.username&&this.password?64:0;b|=a.clean_session?2:0;return f(parseInt(b.toString(16),16))};g.prototype.mqttConnect=function(a){var b=e.CONNECT<<4;a=this.createFlagsForConnection({clean_session:a});var d=f(this.keep_alive>>8,this.keep_alive&255),c=k(this.client_id);this.username&&
(c+=k(this.username),this.password&&(c+=k(this.password)));return m(b,k(this.protocol_name)+this.protocol_level+a+d,c)};exports.create=function(a,b){return new g(a,b)};exports.connect=function(a){a=new g(a.host,a);a.connect();return a}